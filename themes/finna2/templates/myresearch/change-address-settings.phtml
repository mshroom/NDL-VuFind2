<!-- START of: finna - myresearch/change-address-settings.phtml -->
<?php
    $patron = $this->auth()->isLoggedIn();
    $updatePhone = $this->ils()->checkFunction('updatePhone', compact('patron'));
    $updateEmail = $this->ils()->checkFunction('updateEmail', compact('patron'));
    $updateAddress = $this->ils()->checkFunction('updateAddress', compact('patron'));
    $needsApproval = $updateAddress['needsApproval'] ?? true;
    // Set up page title:
    $title = $this->translate(($updatePhone || $updateEmail) ? 'request_address_change' : 'request_contact_information_change');
    $this->headTitle($title);

    // Set up myresearch menu
    $this->layout()->finnaMainTabs = $this->context($this)->renderInContext("myresearch/menu.phtml", ['active' => 'profile']);
    // Set up breadcrumbs:
    $this->layout()->breadcrumbs = '<li><a href="' . $this->url('myresearch-home') . '">' . $this->transEsc('Your Account') . '</a></li> <li class="active">' . $this->transEsc('Profile') . '</li>';
?>
<h2><?=$this->escapeHtml($title) ?></h2>
<?=$this->flashmessages()?>
<?php if (!isset($this->requestCompleted) || !$this->requestCompleted): ?>
  <form  name="requestAddressChange" method="post" action="<?=$this->url('myresearch-changeprofileaddress')?>" class="address-form profile-form">
    <?php foreach ($this->fields as $field => $data): ?>
      <div class="form-group">
        <label class="control-label" for="<?=$this->escapeHtmlAttr($field)?>"><?=$this->transEsc($data['label']) ?>:</label>
        <?php
          $value = $this->profile[$field] ?? $this->profile['full_data'][$field] ?? '';
        ?>
        <?php if ('select' === $data['type']): ?>
          <select id="<?=$this->escapeHtmlAttr($field)?>" name="<?=$this->escapeHtmlAttr($field)?>" class="form-control">
            <?php foreach($data['options'] as $optionId => $option): ?>
              <?php $name = $option['name'] ?? $optionId; ?>
              <option value="<?=$this->escapeHtmlAttr($optionId)?>"<?php if ($optionId == $value): ?> selected<?php endif; ?>><?=$this->translate($name)?></option>
            <?php endforeach; ?>
          </select>
        <?php else: ?>
          <input id="<?=$this->escapeHtmlAttr($field)?>" name="<?=$this->escapeHtmlAttr($field)?>" type="<?=$data['type'] ?: 'text'?>" value="<?=$this->escapeHtmlAttr($value) ?>" class="form-control"/>
        <?php endif; ?>
      </div>
    <?php endforeach; ?>
    <div class="form-group">
      <input name="address_change_request" class="btn btn-primary" type="submit" value="<?=$this->transEsc('Send') ?>" />
    </div>
  </form>
<?php endif; ?>
<?php if ($needsApproval): ?>
  <div class="address-change-description">
    <?php if ('driver' === $this->config['method']): ?>
      <?=$this->transEsc('request_change_description_html') ?>
    <?php else: ?>
      <?=$this->transEsc('request_change_email_description_html') ?>
    <?php endif; ?>
  </div>
<?php endif; ?>
<!-- END of: finna - myresearch/change-address-settings.phtml -->
